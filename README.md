# CloudMN RAG Chatbot System

CloudMN docs.cloud.mn —Å–∞–π—Ç—ã–≥ crawl —Ö–∏–π–∂ RAG (Retrieval-Augmented Generation) —Å–∏—Å—Ç–µ–º—Ç—ç–π GPT chatbot. Chatwoot-—Ç–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–ª–∞–≥–¥—Å–∞–Ω.

## –û–Ω—Ü–ª–æ–≥ —à–∏–Ω–∂ —á–∞–Ω–∞—Ä—É—É–¥

- üìß **–ò–º—ç–π–ª –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç**: –•—ç—Ä—ç–≥–ª—ç–≥—á —ç—Ö–ª—ç—ç–¥ –∏–º—ç–π–ª—ç—ç –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–Ω–∞
- ü§ñ **AI Chatbot**: OpenAI Assistant-—Ç–∞–π —Ö–æ–ª–±–æ–ª—Ç
- üìö **RAG System**: CloudMN docs —Å–∞–π—Ç–∞–∞—Å –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–∂ —Ö–∞—Ä–∏—É–ª–Ω–∞
- üîç **Web Crawling**: docs.cloud.mn —Å–∞–π—Ç—ã–≥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä crawl —Ö–∏–π—Ö
- üíæ **Vector Database**: FAISS –∞—à–∏–≥–ª–∞–Ω embedding —Ö–∞–¥–≥–∞–ª–∞—Ö
- üì± **Teams Integration**: –¢–µ—Ö–Ω–∏–∫–∏–π–Ω –∞—Å—É—É–¥–ª—ã–≥ Microsoft Teams-–¥ –º—ç–¥—ç—ç–ª—ç—Ö
- üîÑ **Cache System**: Crawl —Ö–∏–π—Å—ç–Ω –º—ç–¥—ç—ç–ª–ª–∏–π–≥ cache —Ö–∏–π—Ö
- üß† **Smart Query Logic**: –ò–∂–∏–ª —Ç”©—Ä–ª–∏–π–Ω –∞—Å—É—É–ª—Ç–∞–Ω–¥ –Ω—ç–≥ —É–¥–∞–∞–¥–∞–∞ URL ”©–≥—á, —à–∏–Ω—ç –∞—Å—É—É–¥–∞–ª–¥ –ª —à–∏–Ω—ç —Ö–∞–π–ª—Ç —Ö–∏–π—Ö
- ‚ö° **Optimized Escalation**: –ó”©–≤—Ö”©–Ω “Ø–Ω—ç—Ö—ç—ç—Ä —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π “Ø–µ–¥ –ª –¥—ç–º–∂–ª—ç–≥–∏–π–Ω –±–∞–≥—Ç –º—ç–¥—ç—ç–ª—ç—Ö

## –°—É—É–ª–≥–∞–ª—Ç

1. Dependencies —Å—É—É–ª–≥–∞—Ö:

```bash
pip install -r requirements.txt
```

2. Environment —Ö—É–≤—å—Å–∞–≥—á–¥—ã–≥ —Ç–æ—Ö–∏—Ä—É—É–ª–∞—Ö (.env —Ñ–∞–π–ª “Ø“Ø—Å–≥—ç—Ö):

```bash
# OpenAI —Ç–æ—Ö–∏—Ä–≥–æ–æ
OPENAI_API_KEY=your-openai-api-key
ASSISTANT_ID=your-assistant-id

# Chatwoot —Ç–æ—Ö–∏—Ä–≥–æ–æ
CHATWOOT_API_KEY=your-chatwoot-api-key
ACCOUNT_ID=your-account-id

# Email —Ç–æ—Ö–∏—Ä–≥–æ–æ
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SENDER_EMAIL=your-email@gmail.com
SENDER_PASSWORD=your-app-password

# Teams —Ç–æ—Ö–∏—Ä–≥–æ–æ (–∑–∞–∞–≤–∞–ª –±–∏—à)
TEAMS_WEBHOOK_URL=your-teams-webhook-url

# JWT —Ç–æ—Ö–∏—Ä–≥–æ–æ
JWT_SECRET=your-secret-key-here
VERIFICATION_URL_BASE=http://localhost:5000

# RAG —Å–∏—Å—Ç–µ–º–∏–π–Ω —Ç–æ—Ö–∏—Ä–≥–æ–æ
RAG_ENABLED=true
CRAWL_MAX_PAGES=100
ESCALATION_THRESHOLD=3
```

3. –ê–ø–ø –∞–∂–∏–ª–ª—É—É–ª–∞—Ö:

```bash
python main.py
```

## RAG –°–∏—Å—Ç–µ–º–∏–π–Ω –ê—à–∏–≥–ª–∞–ª—Ç

### 1. Vector Store “Ø“Ø—Å–≥—ç—Ö

```bash
curl -X POST http://localhost:5000/rag/build
```

### 2. RAG —Å—Ç–∞—Ç—É—Å —à–∞–ª–≥–∞—Ö

```bash
curl http://localhost:5000/rag/status
```

### 3. CloudMN docs-–∞–∞—Å —Ö–∞–π–ª—Ç —Ö–∏–π—Ö (—Ç–µ—Å—Ç)

```bash
curl -X POST http://localhost:5000/rag/search \
  -H "Content-Type: application/json" \
  -d '{"query": "—Å–µ—Ä–≤–µ—Ä “Ø“Ø—Å–≥—ç—Ö", "k": 5}'
```

### 4. Cache —Ü—ç–≤—ç—Ä–ª—ç–∂ —à–∏–Ω—ç—ç—Ä crawl —Ö–∏–π—Ö

```bash
curl -X POST http://localhost:5000/rag/refresh
```

### 5. –ê—Å—É—É–ª—Ç—ã–Ω –ª–æ–≥–∏–∫ —Ç–µ—Å—Ç —Ö–∏–π—Ö

```bash
curl -X POST http://localhost:5000/rag/test-query \
  -H "Content-Type: application/json" \
  -d '{"conv_id": "test_123", "query": "—Å–µ—Ä–≤–µ—Ä “Ø“Ø—Å–≥—ç—Ö"}'
```

### 6. –ê—Å—É—É–ª—Ç—ã–Ω —Ç“Ø“Ø—Ö —Ü—ç–≤—ç—Ä–ª—ç—Ö

```bash
# –ë“Ø—Ö conversation-—ã —Ç“Ø“Ø—Ö —Ü—ç–≤—ç—Ä–ª—ç—Ö
curl -X POST http://localhost:5000/rag/clear-history \
  -H "Content-Type: application/json" \
  -d '{"conv_id": "all"}'

# –¢–æ–¥–æ—Ä—Ö–æ–π conversation —Ü—ç–≤—ç—Ä–ª—ç—Ö
curl -X POST http://localhost:5000/rag/clear-history \
  -H "Content-Type: application/json" \
  -d '{"conv_id": "specific_conv_id"}'
```

## API Endpoints

- `POST /webhook` - Chatwoot webhook
- `GET /verify` - –ò–º—ç–π–ª –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–ª—Ç
- `GET /rag/status` - RAG —Å–∏—Å—Ç–µ–º —Å—Ç–∞—Ç—É—Å
- `POST /rag/build` - Vector store “Ø“Ø—Å–≥—ç—Ö
- `POST /rag/search` - RAG —Ö–∞–π–ª—Ç (—Ç–µ—Å—Ç)
- `POST /rag/refresh` - Cache —Ü—ç–≤—ç—Ä–ª—ç–∂ —à–∏–Ω—ç—á–ª—ç—Ö
- `POST /rag/test-query` - –ê—Å—É—É–ª—Ç—ã–Ω –ª–æ–≥–∏–∫ —Ç–µ—Å—Ç —Ö–∏–π—Ö
- `POST /rag/clear-history` - –ê—Å—É—É–ª—Ç—ã–Ω —Ç“Ø“Ø—Ö —Ü—ç–≤—ç—Ä–ª—ç—Ö
- `GET /test-teams` - Teams webhook —Ç–µ—Å—Ç
- `GET /debug-env` - Environment —Ö—É–≤—å—Å–∞–≥—á —Å—Ç–∞—Ç—É—Å

## –ê–∂–∏–ª–ª–∞–≥–∞–∞–Ω—ã –¥–∞—Ä–∞–∞–ª–∞–ª

1. **–•—ç—Ä—ç–≥–ª—ç–≥—á –º–µ—Å—Å–µ–∂ –∏–ª–≥—ç—ç—Ö** ‚Üí Chatwoot webhook
2. **–ò–º—ç–π–ª —à–∞–ª–≥–∞—Ö** ‚Üí –•—ç—Ä—ç–≤ –±–∞—Ç–∞–ª–≥–∞–∞–∂—É—É–ª–∞–∞–≥“Ø–π –±–æ–ª –∏–º—ç–π–ª —à–∞–∞—Ä–¥–∞—Ö
3. **RAG —Ö–∞–π–ª—Ç** ‚Üí CloudMN docs-–∞–∞—Å —Ö–æ–ª–±–æ–≥–¥–æ—Ö –º—ç–¥—ç—ç–ª—ç–ª –æ–ª–æ—Ö
4. **AI —Ö–∞—Ä–∏—É–ª—Ç** ‚Üí OpenAI Assistant + RAG –º—ç–¥—ç—ç–ª–ª—ç—ç—Ä —Ö–∞—Ä–∏—É–ª—Ç “Ø“Ø—Å–≥—ç—Ö
5. **Teams –º—ç–¥—ç—ç–ª—ç–ª** ‚Üí –®–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π “Ø–µ–¥ —Ç–µ—Ö–Ω–∏–∫–∏–π–Ω –±–∞–≥—Ç –∏–ª–≥—ç—ç—Ö

## RAG –°–∏—Å—Ç–µ–º–∏–π–Ω –£—Ö–∞–∞–ª–∞–≥ –õ–æ–≥–∏–∫

### –ê—Å—É—É–ª—Ç—ã–Ω –¢”©—Ä–ª–∏–π–Ω –¢–∞–Ω–∏–ª—Ç

- **–ê–Ω—Ö–Ω—ã –∞—Å—É—É–ª—Ç**: –®–∏–Ω—ç conversation —ç—Ö–ª—ç—Ö “Ø–µ–¥ - RAG —Ö–∞–π–ª—Ç —Ö–∏–π–∂ URL –æ–ª–≥–æ–Ω–æ
- **–ò–∂–∏–ª —Ç”©—Ä–ª–∏–π–Ω –∞—Å—É—É–ª—Ç**: ”®–º–Ω”©—Ö –∞—Å—É—É–ª—Ç—Ç–∞–π –∏–∂–∏–ª —Ç”©—Ä–ª–∏–π–Ω —Ç–µ—Ö–Ω–∏–∫–∏–π–Ω –∞—Å—É—É–¥–∞–ª - ”©–º–Ω”©—Ö URL –∞—à–∏–≥–ª–∞–Ω–∞
- **–®–∏–Ω—ç —Ç”©—Ä–ª–∏–π–Ω –∞—Å—É—É–ª—Ç**: ”®”©—Ä —Ç”©—Ä–ª–∏–π–Ω –∞—Å—É—É–¥–∞–ª - —à–∏–Ω—ç RAG —Ö–∞–π–ª—Ç —Ö–∏–π–∂ —à–∏–Ω—ç URL –æ–ª–≥–æ–Ω–æ

### URL –ú–µ–Ω–µ–∂–º–µ–Ω—Ç

- Conversation –±“Ø—Ä—Ç —Å“Ø“Ø–ª–¥ –æ–ª–¥—Å–æ–Ω URL —Ö—É—É–¥—Å—É—É–¥—ã–≥ —Ö–∞–¥–≥–∞–ª–Ω–∞
- –ò–∂–∏–ª —Ç”©—Ä–ª–∏–π–Ω –∞—Å—É—É–ª—Ç–∞–Ω–¥ –¥–∞—Ö–∏–Ω —Ö–∞–π–ª—Ç —Ö–∏–π—Ö–≥“Ø–π–≥—ç—ç—Ä ”©–º–Ω”©—Ö URL-“Ø“Ø–¥–∏–π–≥ —Å–∞–Ω–∞–ª –±–æ–ª–≥–æ–Ω–æ
- –®–∏–Ω—ç –∞—Å—É—É–¥–∞–ª –æ—Ä–∂ –∏—Ä–≤—ç–ª —à–∏–Ω—ç URL —Ö–∞–π–∂, —Ö—É—É—á–∏–Ω URL-—ã–≥ —Å–æ–ª–∏–Ω–æ

### –î—ç–º–∂–ª—ç–≥–∏–π–Ω –ë–∞–≥—Ç –ú—ç–¥—ç—ç–ª—ç—Ö –®–∞–ª–≥—É—É—Ä

- **–ê—Å—É—É–ª—Ç—ã–Ω —Ç–æ–æ**: `ESCALATION_THRESHOLD` (–∞–Ω—Ö–¥–∞–≥—á: 3) —Ö“Ø—Ä–≤—ç–ª –º—ç–¥—ç—ç–ª—ç—Ö
- **–Ø–∞—Ä–∞–ª—Ç–∞–π —Ç“Ø–ª—Ö“Ø“Ø—Ä “Ø–≥—Å**: "–∞–ª–¥–∞–∞ –≥–∞—Ä—á –±–∞–π–Ω–∞", "—Ç—É—Å–ª–∞–º–∂ —Ö—ç—Ä—ç–≥—Ç—ç–π" –≥—ç—Ö –º—ç—Ç
- **AI –∞–ª–¥–∞–∞**: –û–ª–æ–Ω —É–¥–∞–∞ –¥–∞—Ä–∞–∞–ª–∞–Ω AI –∞–ª–¥–∞–∞ –≥–∞—Ä–≤–∞–ª –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä –º—ç–¥—ç—ç–ª—ç—Ö
- **RAG –∏–¥—ç–≤—Ö–≥“Ø–π**: RAG —Å–∏—Å—Ç–µ–º –∞–∂–∏–ª–ª–∞—Ö–≥“Ø–π –±–æ–ª –º—ç–¥—ç—ç–ª—ç—Ö

## –§–∞–π–ª—ã–Ω –±“Ø—Ç—ç—Ü

- `main.py` - –ì–æ–ª –∞–ø–ø —Ñ–∞–π–ª
- `requirements.txt` - Python dependencies
- `cloudmn_crawl_cache.json` - Crawl —Ö–∏–π—Å—ç–Ω –º—ç–¥—ç—ç–ª–ª–∏–π–Ω cache
- `cloudmn_vectorstore.faiss` - FAISS vector database
- `cloudmn_vectorstore.pkl` - Vector store metadata

## –•”©–≥–∂“Ø“Ø–ª—ç–ª—Ç–∏–π–Ω —Ç—ç–º–¥—ç–≥–ª—ç–ª

- Cache —Å–∏—Å—Ç–µ–º –∞—à–∏–≥–ª–∞–Ω –¥–∞–≤—Ç–∞–Ω crawl —Ö–∏–π—Ö—ç—ç—Å –∑–∞–π–ª—Å—Ö–∏–π—Ö
- Vector store –Ω—ç–≥ —É–¥–∞–∞ “Ø“Ø—Å–≥—ç–∂, –¥–∞—Ä–∞–∞ –Ω—å memory-–¥ –∞—á–∞–∞–ª–∞—Ö
- Teams integration-—ã–≥ –∞—Å—É—É–¥–ª—ã–Ω –¥“Ø–≥–Ω—ç–ª—Ç—ç–¥ –∞—à–∏–≥–ª–∞—Ö
- Retry logic AI –∞–ª–¥–∞–∞ –≥–∞—Ä–≤–∞–ª –¥–∞—Ö–∏–Ω –æ—Ä–æ–ª–¥–æ—Ö
- **–®–∏–Ω—ç**: –ê—Å—É—É–ª—Ç—ã–Ω —Ç”©—Ä–ª–∏–π–≥ GPT-—ç—ç—Ä —Ç–∞–Ω–∏–Ω –∏–∂–∏–ª –∞—Å—É—É–¥–∞–ª–¥ –¥–∞–≤—Ç–∞–Ω —Ö–∞–π–ª—Ç —Ö–∏–π—Ö–≥“Ø–π –±–∞–π—Ö
- **–®–∏–Ω—ç**: URL —Ö–∞–¥–≥–∞–ª–∞–ª—Ç –±–∞ conversation-–Ω—ã —Ç“Ø“Ø—Ö –º–µ–Ω–µ–∂–º–µ–Ω—Ç
- **–®–∏–Ω—ç**: Escalation –ª–æ–≥–∏–∫–∏–π–≥ —Ö—è–∑–≥–∞–∞—Ä–ª–∞–∂ –∑”©–≤—Ö”©–Ω —à–∞–∞—Ä–¥–ª–∞–≥–∞—Ç–∞–π “Ø–µ–¥ Teams-–¥ –º—ç–¥—ç—ç–ª—ç—Ö

## –¢–µ—Å—Ç–ª—ç—Ö –∑–∞–∞–≤–∞—Ä

### 1. RAG –ª–æ–≥–∏–∫ —Ç–µ—Å—Ç

```bash
# –ê–Ω—Ö–Ω—ã –∞—Å—É—É–ª—Ç - —à–∏–Ω—ç —Ö–∞–π–ª—Ç —Ö–∏–π—Ö —ë—Å—Ç–æ–π
curl -X POST http://localhost:5000/rag/test-query \
  -d '{"conv_id": "test", "query": "—Å–µ—Ä–≤–µ—Ä “Ø“Ø—Å–≥—ç—Ö"}'

# –ò–∂–∏–ª —Ç”©—Ä–ª–∏–π–Ω –∞—Å—É—É–ª—Ç - —Ö–∞–π–ª—Ç —Ö–∏–π—Ö–≥“Ø–π
curl -X POST http://localhost:5000/rag/test-query \
  -d '{"conv_id": "test", "query": "—Å–µ—Ä–≤–µ—Ä–∏–π–≥ —Ö—ç—Ä—Ö—ç–Ω –±—ç–ª–¥—ç—Ö –≤—ç"}'

# ”®”©—Ä —Ç”©—Ä–ª–∏–π–Ω –∞—Å—É—É–ª—Ç - —à–∏–Ω—ç —Ö–∞–π–ª—Ç —Ö–∏–π—Ö
curl -X POST http://localhost:5000/rag/test-query \
  -d '{"conv_id": "test", "query": "–¥–æ–º–∞–π–Ω –Ω—ç—Ä –±“Ø—Ä—Ç–≥—ç—Ö"}'
```

### 2. Escalation —Ç–µ—Å—Ç

```bash
# –û–ª–æ–Ω –∞—Å—É—É–ª—Ç –≥–∞—Ä–≥–∞–∂ escalation threshold —Ö“Ø—Ä“Ø“Ø–ª—ç—Ö
for i in {1..4}; do
  curl -X POST http://localhost:5000/rag/test-query \
    -d "{\"conv_id\": \"escalation_test\", \"query\": \"–∞—Å—É—É–ª—Ç $i\"}"
done
```

## –ê–ª–¥–∞–∞ –∑–∞—Å–∞–ª—Ç

- `RAG —Å–∏—Å—Ç–µ–º –∏–¥—ç–≤—Ö–≥“Ø–π` - `RAG_ENABLED=true` —Ç–æ—Ö–∏—Ä—É—É–ª–Ω–∞ —É—É
- `Vector store –æ–ª–¥—Å–æ–Ω–≥“Ø–π` - `/rag/build` –¥—É—É–¥–∞–∂ —ç—Ö–ª—ç—ç–¥ “Ø“Ø—Å–≥—ç–Ω–∞ “Ø—É
- `Crawl –∞–ª–¥–∞–∞` - –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —Ö–æ–ª–±–æ–ª—Ç, docs.cloud.mn —Ö“Ø—Ä—Ç—ç—ç–º–∂—Ç—ç–π —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞ —É—É
- `–ò–∂–∏–ª –∞—Å—É—É–ª—Ç —Ç–∞–Ω–∏—Ö–≥“Ø–π` - GPT-3.5-turbo —Ö–æ–ª–±–æ–ª—Ç —à–∞–ª–≥–∞–Ω–∞ —É—É
- `Teams –º—ç–¥—ç—ç–ª—ç—Ö –∞–ª–¥–∞–∞` - `TEAMS_WEBHOOK_URL` –∑”©–≤ —Ç–æ—Ö–∏—Ä—É—É–ª—Å–∞–Ω —ç—Å—ç—Ö–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞ —É—É
